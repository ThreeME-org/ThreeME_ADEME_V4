---
title: "Simulation d'une taxe carbon identique sur des pays européens"
subtitle: "Scénario: `r params$scenario_name`"
author: "ThreeME team"
date: "`r format(Sys.Date(), '%d %B %y')`"
output: slidy_presentation
params:
  startyear: 2020
  endyear: 2050
  scenario_name: carbontax
  classification: c28_s32
  template_default: ofce
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	results = "hide"
)
```

```{r Plots default options}



startyear <- params$startyear
endyear <- params$endyear
scenario_name <- params$scenario_name
classification <- params$classification
template_default <- params$template_default

```

The template is employed to better visualize the results of the first tests of ThreeME models done by Jin. The tested models include: Austria, Germany, Spain, Finland, Greece, Switzerland, Denmark, Estonia and Great Britain.

I introduce, for all countries under the test, the same carbon tax (except Austria, where the level of carbon tax seems too high for this country) in order to check if there are anomalies in terms of resolution of Eviews as well as its outputs, with which we could find, by comparing outputs between different countries, potential errors in the calibration framework.

The level of the tax imposed here is only to diagnose the functioning of these models.

```{r Required packages, message=FALSE, warning=FALSE}
source("src/functions.R")
# source("src/functions_ermeeth.R")
# Package Ermeeth est chargé par ce code, mais il n'est pas compatible avec des analyses des plusieurs pays en même temps. J'essaie de réaliser cette analyse entre pays - Jin


#Definition of country and indicators to analysis
country_list           <- c("che","deu","dnk","esp","est","fin","gbr","grc","lux","aut")
#country_list <- c("aut","che","deu","dnk","esp","est","fin","gbr","grc","bel","lux","hun","ita","pol","fra","lva","prt","swe")
country_names          <- c("Switzerland","Germany","Denmark","Spain","Estonia","Finland","Great Britain","Greece","Luxembourg","Austria")
#country_names          <- c("Austria","Switzerland","Germany","Denmark","Spain","Estonia","Finland","Great Britain","Greece","Belgique","Luxembourg","Hungry","Italy","Poland","France","Lettovia","Portugal","Sweden")

indicateur_list        <- c("GDP","I","CH","X","M","G","DS","MGS","CI","PGDP","PG",
                            "VA","PVA",
                            "Y","PY",
                            "DISPINC_AT_VAL","UNR","RSAV_G_VAL","RBAL_G_PRIM_VAL","RBAL_G_TOT_VAL","RDEBT_G_VAL",
                            "SPEND_G_VAL","INC_G_VAL","SOC_BENF_VAL","DEBT_G_VAL","PHI_RD_G","R_DEBT_G",
                            "PNTAXC","NTAXC","NTAXS_VAL","INC_SOC_TAX_VAL","PRSC","RSC","PROP_INC_G_VAL",
                            "EMS_CO2","CH_TOE",
                            "F_L","F_K","F_E","F_MAT",
                            "C_L","C_K","C_E","C_MAT",
                            "BAL_TRADE_VAL")

sindicateur_list <- c("GDP","I","CH","X","M","G","DS","MGS","CI","PGDP",
                      "Y","PY",
                      "VA","PVA","VA_VAL",
                      "F_L","F_E","F_K","F_MAT","C_L","C_K","C_E","C_MAT",
                      "EMS_CI_CO2","EMS_Y_CO2","EMS_MAT_CO2","CI_TOE")

list_rationames <- c( 
  "PHI_FL_Y_S",
  "PHI_FK_Y_S",
  "PHI_I_Y_S",
  "PHI_FMAT_Y_S",
  "PHI_FE_Y_S",
  "PHI_VAL_K_Y_S",
  "PHI_VAL_L_Y_S",
  "PHI_VAL_E_Y_S",
  "PHI_VAL_MAT_Y_S",
  "PHI_VAL_Y_S",
  "PHI_VAL_L_VA_S",
  "PHI_VAL_PI_VA_S",
  "PHI_MGS_GDP_C",
  "PHI_CI_GDP_C",
  "PHI_FE_GDP_S",
  "PHI_CH_GDP_C",
  "PHI_G_GDP_C",
  "PHI_I_GDP_C",
  "PHI_X_GDP_C",
  "PHI_M_GDP_C",
  "BLC_TRADE_C",
  "OPN_TRADE_C",
  "PVA_S"
)

source(paste0("src/bridges/bridge_",classification,".R"))
source(paste0("src/bridges/codenames_",classification,".R"))
```


```{r}

#Creation of database for multi-countries analysis
data <- country_list %>% purrr::set_names() %>%
             map(~ readRDS(file = paste0("databases/carbontax_",.x,"_c28_s32_commodities_sectors.rds")) %>% 
                   as.data.frame() %>% 
                   filter( variable %in% indicateur_list |
                           grepl(paste(paste0("^",sindicateur_list,
                                                  "_[A-Z0-9]{4}$"),collapse = "|"),variable)) %>%
                   set_names(c("variable","year","baseline",scenario_name,"commodity","sector"))
                 ) 

data <- data %>%
             map(~.x %>% 
                 wide_data(variables =
                             c(variables_like(.,paste(paste0("^",sindicateur_list,"_[A-Z0-9]{4}$"),collapse = "|"),FALSE),indicateur_list), 
                           out_format = "list") %>%  ## 1. passe en wide
                 map(~.x %>%  ## 2. calcul des indicateurs
                     mutate(
                       # creation of the macro ratios
                     FEC = CH_TOE + CI_TOE_S001 + CI_TOE_S002 + CI_TOE_S003 + CI_TOE_S004 + CI_TOE_S005 + CI_TOE_S006,
                     PHI_FL_Y = F_L/Y,
                     PHI_FK_Y = F_K/Y,
                     PHI_I_Y = I/Y,
                     PHI_FMAT_Y = F_MAT/Y,
                     PHI_FE_Y = F_E/Y,
                     PHI_VAL_K_Y = C_K*F_K/(PY*Y),
                     PHI_VAL_L_Y = C_L*F_L/(PY*Y),
                     PHI_VAL_E_Y = C_E*F_E/(PY*Y),
                     PHI_VAL_MAT_Y = C_MAT*F_MAT/(PY*Y),
                     PHI_VAL_Y = PVA*VA/(PY*Y),
                     PHI_VAL_L_VA = C_L*F_L/(PVA*VA),
                     PHI_VAL_PI_VA = 1 - C_L*F_L/(PVA*VA),
                     PHI_MGS_GDP = MGS/GDP,
                     PHI_CI_GDP = CI/GDP,
                     PHI_FE_GDP = F_E/GDP,
                     PHI_CH_GDP = CH/GDP,
                     PHI_G_GDP = G/GDP,
                     PHI_I_GDP = I/GDP,
                     PHI_X_GDP = X/GDP,
                     PHI_M_GDP = M/GDP,
                     BLC_TRADE = (X-M)/GDP,
                     OPN_TRADE = (X+M)/GDP,
                     PHI_VAL_SPEND_G_GDP = SPEND_G_VAL/(PGDP*GDP),
                     PHI_VAL_INC_G_GDP = INC_G_VAL/(PGDP*GDP),
                     NTAXC_VAL = PNTAXC*NTAXC,
                     RSC_VAL = PRSC*RSC
                         ) ) %>% 
                 long_data() %>% ## 3. repasse en wide
                 rbind(.x) %>% ## 4. on recolle à la base
                 unique() ## 5. on enleve les doublons
             )

data_wide <- data %>%
  map(~.x %>% 
        wide_data(variables =
                    c(variables_like(.,paste(paste0("^",sindicateur_list,"_[A-Z0-9]{4}$"),collapse = "|"),FALSE),indicateur_list), 
                  out_format = "list")) 

#creation of sectorial ratios
for (j in 1:length(country_list)) {
  for(k in 1:2) {
    data_temp <- data_wide[[j]][[k]]
    for (i in 1:8) {
      list_numerator <- list(
        select(data_temp,grep(paste0("^","F_L","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","F_K","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","I","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","F_MAT","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","F_E","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","C_K","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","F_K","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","C_L","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","F_L","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","C_E","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","F_E","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","C_MAT","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","F_MAT","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(fixed("PVA"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","VA","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","C_L","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","F_L","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(fixed("PVA"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","VA","_S00",i,"$"),names(data_temp)))-
          select(data_temp,grep(paste0("^","C_L","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","F_L","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","MGS","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","CI","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","F_E","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","CH","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","G","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","I","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","X","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","M","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","X","_C00",i,"$"),names(data_temp)))-
          select(data_temp,grep(paste0("^","M","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","X","_C00",i,"$"),names(data_temp)))+
          select(data_temp,grep(paste0("^","M","_C00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","VA_VAL","_S00",i,"$"),names(data_temp)))
        )
      for (l in 1:length(list_numerator)) {
        if(is_empty(list_numerator[[l]]) == TRUE){
          list_numerator[[l]] = 0
        }}
      list_denominator <- list(
        select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","PY","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","PY","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","PY","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","PY","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^","PY","_S00",i,"$"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","Y","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(fixed("PVA"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","VA","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(fixed("PVA"),names(data_temp)))* 
          select(data_temp,grep(paste0("^","VA","_S00",i,"$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^GDP$"),names(data_temp))),
        select(data_temp,grep(paste0("^","VA","_S00",i,"$"),names(data_temp)))
        )
      data_cal <- map2(list_numerator,list_denominator,~ .x/.y)  %>%
        reduce(cbind) %>%
        set_names(paste0(list_rationames,"00",i))
      data_wide[[j]][[k]] <- cbind(data_wide[[j]][[k]],data_cal)
      }}}
rm(data_temp,data_cal)

data_wide <- data_wide %>% map(~.x %>% long_data())

data <- map2(data,data_wide,
             ~.x %>% rbind(.y) %>% unique())

rm(data_wide)

#Creation of other basic data for analysis
#data_EMS <- data_sector %>%
#            filter(grepl("^EMS_.+_CO2_S[A-Z0-9]{3}$",variable)) %>%
#            mutate(variable = str_remove(variable,"_(CI|MAT|Y)")) %>%
#            aggregate(cbind(baseline,.[,4]) ~ year + country + variable + sector ,., FUN = sum) %>%
#            set_names(c("year","country","variable","sector","baseline",scenario_name)) %>%
#            mutate(commodity = NA) %>%
#            select(c(variable,year,baseline,scenario_name,commodity,sector,country))
  
#data_sector <- data_sector %>% rbind(data_EMS)

#rm(data_FEC,data_EMS)
```



# Impact at national level

The following are the key macroeconomic and national-level emissions indicators of the carbon tax tested.

## Indicators in level

```{r macro indicators in level, fig.height = 7, fig.width = 14}

A <- data %>%
     imap(~.x %>% filter(variable %in% "PHI_I_Y") %>% mutate(variable = .y)) %>%
     reduce(rbind) %>%
     simpleplot(country_list, country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 1, titleplot = "I/Y")

#B <- simpleplot(data_full,"I",multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", transformation = "level", unit = 1,  titleplot = "Investment in level for different countries  (Dashed line for BAU)")

#C <- simpleplot(data_full, "DISPINC_AT_VAL",multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", transformation = "level", unit = 1, titleplot = "Household disponible revenue in level for different countries (Dashed line for BAU)")

#D <- simpleplot(data_full, "EMS_CO2", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", transformation = "level", unit = 1, titleplot = "CO2 emissions in level for different countries (Dashed line for BAU)")

E <- simpleplot(data_full, "UNR", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", transformation = "level", titleplot = "Unemployment rate for different countries (Dashed line for BAU)")


pictures <- ggarrange(A,B,C,D,E,
                   hjust = -0.5, vjust = 1.5,
                   ncol = 2, nrow = 2,
                   widths = 2,  heights = 2,
                   common.legend = TRUE, legend = "top")

pictures
```

------------------------------------------------------------------------

## Indicators in percent difference from baseline

```{r macro indicators in relative difference, fig.height = 7, fig.width = 14}

A <- simpleplot(data_full,"GDP", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", titleplot = "GDP impact for different countries  (in difference from baseline)")

B <- simpleplot(data_full,"I", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", titleplot = "GDP impact for different countries  (in difference from baseline)")

C <- simpleplot(data_full,"DISPINC_AT_VAL", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", titleplot = "GDP impact for different countries  (in difference from baseline)")

D <- simpleplot(data_full,"EMS_CO2", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", titleplot = "GDP impact for different countries  (in difference from baseline)")

E <- simpleplot(data_full,"UNR", multi_country = country_list, country_names, startyear, endyear, scenario = "carbontax", titleplot = "GDP impact for different countries  (in difference from baseline)")

#macro <- ggarrange(A,B,C,D,
#                   labels = c("(a)", "(b)", "(c)", "(d)"),
#                   hjust = -0.5, vjust = 1.5,
#                   ncol = 2, nrow = 2,
#                   widths = 2,  heights = 1)

 ## Save image on disk for further use (ready to be activated)
 # ggsave("macro.svg", device = svg, width = 32,  height = 16, units = c("cm"))

## See the graph in Mark-down
#  macro

pictures <- ggarrange(A,B,C,D,E,
                   hjust = -0.5, vjust = 1.5,
                   ncol = 2, nrow = 2,
                   widths = 2,  heights = 2,
                   common.legend = TRUE, legend = "top")

pictures

```

------------------------------------------------------------------------

```{r Comparaison entre baseline et reference}
#Validation of model framework

data_gdp2019 <- data_full %>% 
                filter(year == 2019,grepl("^GDP",variable)) %>% 
                select(variable,country,year,baseline) %>% 
                mutate(Eurostat = c(653732.6, 3473350.0, 310475.6, 1244375.0, 
                                     27732.3, 239852.0, 2526615.2, 183250.4,62704.2,397518.5),
                       Diff.EuroS = baseline/Eurostat - 1)

# Data source: Eurostat in million EUR, GDP at market prices (GDP nominal)
# NB: GDP (Real GDP) in 3ME, but on 2019 PGDP = 1

data_ems2019 <- data_full %>% 
                filter(year == 2019,grepl("^EMS",variable)) %>% 
                select(variable,country,year,baseline) %>% 
                mutate(BP = c(38.2, 681.5, 0, 271.0, 
                                     0, 43.4, 380.2, 76.7,0,63.7),
                       Diff.BP = baseline/BP - 1)
#                       Exiobase = c(28.7, 646.3, 41.6, 213.0, 
#                                     14.3, 41.8, 297.9, 128.1),
#                       Diff.Exio = baseline/Exiobase - 1)
# Data source: UK Department for Business, Energy and Industrial Strategy for UK
#              BP for the rest countries
#              Unit in milion tonnes CO2

data_fec2019 <- data_full %>% 
                filter(year == 2019,grepl("^FEC",variable)) %>% 
                select(variable,country,year,baseline) %>% 
                mutate(Eurostat = c(834210, 8407276, 567174, 3412819, 
                                     118206, 1035333, 5614498.8, 644813,0,0),
                       Difference = baseline/Eurostat - 1)
# Data source: Switzerland from Swiss Federal of Energy in TJ
#              Eurostat for the rest of countries in TJ

```

```{r calcul of ratio}

carbon_over_FEC <- construct_ratio(data_full, rationame = "CO2_int", numerator = "EMS_CO2", denominator = "FEC", 
                              countries = country_list)

FEC_over_GDP <- construct_ratio(data_full, rationame = "FEC_int", numerator = "FEC", denominator = "GDP", 
                              countries = country_list)
```

```{r calcul du taux de croissance}
data_TCAM <- data_full %>% 
             filter(variable %in% c("GDP","EMS_CO2","CH","I"),year %in% c(2019,2030,2050)) %>% 
             select(variable,country,year,baseline) %>% 
             pivot_wider(names_from = year,values_from = baseline) 

data_TCAM <- FEC_over_GDP %>% 
             filter(year %in% c(2019,2030,2050)) %>% 
             select(variable,country,year,baseline) %>% 
             pivot_wider(names_from = year,values_from = baseline) 

data_TCAM <- data_TCAM %>% 
            mutate(TCAM_30 = (data_TCAM$`2030`/data_TCAM$`2019`)^(1/(2030-2019))-1,
                   TCAM_50 = (data_TCAM$`2050`/data_TCAM$`2019`)^(1/(2050-2019))-1)

data_TCAM
```

------------------------------------------------------------------------

## Energy mix

```{r energy mix}
Primary_energy <- c("CCOI","CCOA","CGAS")

data_ene_mix <- country_list %>% 
                map_df(~ readRDS(file = paste0("databases/carbontax_",.x,"_c28_s32.rds")) %>% 
                as.data.frame() %>% 
                filter(variable %in% c(paste0("CH_TOE_",Primary_energy),paste0("CI_TOE_",Primary_energy))) %>% 
                mutate(country = .x) %>%
                set_names(c("variable","year","baseline",scenario_name,"sector","commodity","country"))
               )


data_fig <- data_ene_mix %>%
               filter(year %in% c("2019"))

fig <- ggplot(data_fig, aes(x = country, y = baseline, fill = commodity)) + 
         geom_bar(stat = "identity", position = "fill") + 
         scale_fill_brewer(palette = "Set2") +
         ggtitle("Energy mix for different countries") +
         facet_grid(~ year)
fig


```


------------------------------------------------------------------------

## Electricity mix (Exogenous)

```{r electricity mix}
Elec_list <- c("SENU","SEOI","SEGA","SECO","SEWI","SESO","SEHY","SEOT")

data_ele_mix <- country_list %>% 
                map_df(~ readRDS(file = paste0("databases/carbontax_",.x,"_c28_s32.rds")) %>% 
                as.data.frame() %>% 
                filter(variable %in% paste0("Y_TOE_",Elec_list)) %>% 
                mutate(country = .x) %>%
                set_names(c("variable","year","baseline",scenario_name,"sector","commodity","country"))
               )

data_fig <- data_ele_mix %>%
            filter(year %in% c("2019"))

fig <- ggplot(data_fig, aes(x = country, y = baseline, fill = sector)) + 
         geom_bar(stat = "identity", position = "fill") + 
         scale_fill_brewer(palette = "Set2") +
         ggtitle("Electricity mix for different countries") +
         facet_grid(~ year)
fig

```


------------------------------------------------------------------------

```{r Structure economique}
plot_struc_pays(data = data_sector, indicator = "F_K", country = country_list, years = 2019, scenario = "baseline", title = "Share of factor energy")
plot_struc_pays(data = data_sector, indicator = "F_L", country = country_list, years = 2019,scenario = "baseline")
plot_struc_pays(data = data_sector, indicator = "F_E", country = country_list, years = 2020,scenario = "baseline")
plot_struc_pays(data = data_sector, indicator = "VA", country = country_list, years = 2019,scenario = "baseline",
                title = "Share of added values for each sector")
plot_struc_pays(data = data_sector, indicator = "Y", country = country_list, years = 2019,scenario = "baseline",
                title = "Share of production for each sector")
plot_struc_pays(data = data_sector, indicator = "EMS_CO2", country = country_list, years = 2019, scenario = "baseline",
                title = "Share of CO2 emissions for each sector")


```

```{r decomposition de PIB,eval=FALSE, include=FALSE}
#un peu de problème avec ce chank

GDP_comp <- c("CH","X","M","I","G","DS")

GDP_fig <- data_full %>%
            filter(year %in% c("2020","2050"),
                   grepl(paste(paste0("^",GDP_comp,"_.*"),collapse = "|"),variable)) %>%
            mutate(country = str_remove(variable, paste(paste0("^",GDP_comp,"_"),collapse = "|")),
                   indicator = str_remove(variable, paste(paste0("_",country_list),collapse = "|")))


fig <- ggplot(GDP_fig, aes(x = country, y = GDP_fig[,"baseline"], fill = indicator)) + 
       geom_bar(stat = "identity", position = "fill") + 
       ylab("scenario") +
       ggtitle(paste0("Economy structure of its compositions")) +
       facet_grid(~ year)

fig

```


------------------------------------------------------------------------

```{r decomposition de PIB, eval=FALSE, include=FALSE}
#Decomposition of GDP growth rate for tested countries

GDP_comp <- c("CH","BAL_TRADE_VAL", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Trade balance", "Investment", "Public spending","Stock variation")


data_plot <- contrib(data[[2]],"GDP", GDP_comp,indicator = "share", scenar = "carbontax")

A <- contrib.plot(data_plot, series = GDP_comp,line_tot = TRUE,
                  label_series = GDP_comp_label,
                  startyear = 2020, titleplot = "Compositions of GDP in X")

A
```


```{r decomposition de PIB, eval=FALSE, include=FALSE}

INC_G_comp <- c("NTAXC_VAL","NTAXS_VAL","INC_SOC_TAX_VAL", "RSC_VAL","PROP_INC_G_VAL")
INC_G_comp_label <- c( "Taxes on commodities","Taxes on the production","Income and social taxes", "Social security contribution", "Gouvernment property income")


A <- contrib(data[[2]],"INC_G_VAL", INC_G_comp,indicator = "share", scenar = "carbontax") %>%
contrib.plot(series = INC_G_comp,line_tot = TRUE,
                  label_series = INC_G_comp_label,
                  startyear = 2020, titleplot = "Contribution of gouvernment incomes growth in country X")

A
```


```{r decomposition de PIB, eval=FALSE, include=FALSE}

Y_comp <- c("Y_S001","Y_S002","Y_S003","Y_S004","Y_S005","Y_S006","Y_S007","Y_S008")
Y_comp_label <- c( "Agriculture","Energy intensive industry","Other industry","Construction","Transport","Services","Fossil based energy","Other energy" )


data_plot <- jin(data[["grc"]],"Y", Y_comp,indicator = "share", scenar = "carbontax")

A <- contrib.plot(data_plot, series = Y_comp,line_tot = TRUE,
                  label_series = Y_comp_label,
                  startyear = 2020, titleplot = "Share of sectorial production in country X")

A
```

# Impact in sectorial level by country

```{r}
curve_sc_plot(data[["grc"]],"OPN_TRADE",scenario = "carbontax",
              group_type = "C",
              growth.rate = FALSE,diff = FALSE,abs.diff = FALSE,
              title = "Trade openess by commodities in Greece ")

curve_sc_plot(data[["deu"]],"OPN_TRADE",scenario = "carbontax",
              group_type = "C",
              growth.rate = FALSE,diff = FALSE,abs.diff = FALSE,
              title = "Trade openess by commodities in Germany ")

curve_sc_plot(data[["deu"]],"PVA",scenario = "carbontax",
              group_type = "S",
              growth.rate = FALSE,diff = FALSE,abs.diff = FALSE,
              title = "Trade openess by commodities in Germany ")

```


```{r}

Fig_Y_sec <- list()
for (i in 1:length(country_list)){
  Fig_Y_sec <- c(Fig_Y_sec,list(curve_sc_plot(data_sector,"Y",countries = country_list[i],scenario = "baseline",
                                                growth.rate = FALSE,diff = FALSE,abs.diff = FALSE, 
                                                title = paste0("Production in level by sector in ",country_names[i]))))
}

#pictures <- ggarrange(A,B,C,D,
#                   labels = c("(a)", "(b)", "(c)", "(d)"),
#                   hjust = -0.5, vjust = 1.5,
#                   ncol = 2, nrow = 2,
#                   widths = 1.5,  heights = 1,
#                   common.legend = TRUE, legend = "top")

#pictures
```

```{r}


Fig_L_sec <- list()
for (i in 1:length(country_list)){
  Fig_L_sec <- c(Fig_L_sec,list(curve_sc_plot(data_sector,"F_L",countries = country_list[i],scenario = "carbontax",
                                                growth.rate = FALSE,diff = FALSE,abs.diff = FALSE, 
                                                title = paste0("Employment in level by sector in ",country_names[i]))))
}

```

```{r eval=FALSE, include=FALSE}
data_plot <- contrib.sub_country(data_sector,var1 =  "F_L", country = "deu",
                        group_type = "sector", scenar = c("baseline", "carbontax"))

A <- contrib.sub.plot(data_plot, template = "ofce", startyear = 2020, endyear = 2050, line_tot =  TRUE, titleplot = "Total production and sectorial decomposition  (in difference from baseline)")

A
```

```{r}

LY <- construct_ratio(data_sector, rationame = "LY", numerator = "F_L", denominator = "Y", 
                      country = country_list,by_sector = TRUE)
KY <- construct_ratio(data_sector, rationame = "KY", numerator = "F_K", denominator = "Y", 
                      country = country_list,by_sector = TRUE)
EnY <- construct_ratio(data_sector, rationame = "EnY", numerator = "F_E", denominator = "Y", 
                       country = country_list,by_sector = TRUE)
EY <- construct_ratio(data_sector, rationame = "EY", numerator = "EMS_CO2", denominator = "Y", 
                      country = country_list,by_sector = TRUE)
data_ratio <- rbind(LY,KY,EnY,EY)
rm(LY,KY,EnY,EY)

```


```{r}

Fig_LY <- list()
for (i in 1:length(country_list)){

  Fig_LY <- c(Fig_LY,list(curve_sc_plot_country(data_ratio,"LY",country = country_list[i],scenario = "carbontax",
                                                growth.rate = FALSE,diff = FALSE,abs.diff = FALSE, 
                                                title = paste0("Sectorial labour intensity over production for ",country_names[i]))))
}

Fig_KY <- list()
for (i in 1:length(country_list)){
  Fig_KY <- c(Fig_KY,list(curve_sc_plot_country(data_ratio,"KY",country = country_list[i],scenario = "carbontax",
                                                growth.rate = FALSE,diff = FALSE,abs.diff = FALSE, 
                                                title = paste0("Sectorial capital intensity over production for ",country_names[i]))))
}

Fig_EnY <- list()
for (i in 1:length(country_list)){
  Fig_EnY <- c(Fig_EnY,list(curve_sc_plot_country(data_ratio,"EnY",country = country_list[i],scenario = "carbontax",
                                                growth.rate = FALSE,diff = FALSE,abs.diff = FALSE, 
                                                title = paste0("Sectorial energy intensity over production for ",country_names[i]))))
}

Fig_EY <- list()
for (i in 1:length(country_list)){
  Fig_EY <- c(Fig_EY,list(curve_sc_plot_country(data_ratio,"EY",country = country_list[i],scenario = "carbontax",
                                                growth.rate = FALSE,diff = FALSE,abs.diff = FALSE, 
                                                title = paste0("Sectorial emission intensity over production for ",country_names[i]))))
}

```

------------------------------------------------------------------------

## Switzerland

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("che",country_list)]],
                 Fig_L_sec[[grep("che",country_list)]],
                 Fig_LY[[grep("che",country_list)]],
                 Fig_KY[[grep("che",country_list)]],
                 Fig_EnY[[grep("che",country_list)]],
                 Fig_EY[[grep("che",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Germany

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("deu",country_list)]],
                 Fig_L_sec[[grep("deu",country_list)]],
                 Fig_LY[[grep("deu",country_list)]],
                 Fig_KY[[grep("deu",country_list)]],
                 Fig_EnY[[grep("deu",country_list)]],
                 Fig_EY[[grep("deu",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Denmark

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("dnk",country_list)]],
                 Fig_L_sec[[grep("dnk",country_list)]],
                 Fig_LY[[grep("dnk",country_list)]],
                 Fig_KY[[grep("dnk",country_list)]],
                 Fig_EnY[[grep("dnk",country_list)]],
                 Fig_EY[[grep("dnk",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Spain

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("esp",country_list)]],
                 Fig_L_sec[[grep("esp",country_list)]],
                 Fig_LY[[grep("esp",country_list)]],
                 Fig_KY[[grep("esp",country_list)]],
                 Fig_EnY[[grep("esp",country_list)]],
                 Fig_EY[[grep("esp",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Estonia

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("est",country_list)]],
                 Fig_L_sec[[grep("est",country_list)]],
                 Fig_LY[[grep("est",country_list)]],
                 Fig_KY[[grep("est",country_list)]],
                 Fig_EnY[[grep("est",country_list)]],
                 Fig_EY[[grep("est",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Finland

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("fin",country_list)]],
                 Fig_L_sec[[grep("fin",country_list)]],
                 Fig_LY[[grep("fin",country_list)]],
                 Fig_KY[[grep("fin",country_list)]],
                 Fig_EnY[[grep("fin",country_list)]],
                 Fig_EY[[grep("fin",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Great Britain

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("gbr",country_list)]],
                 Fig_L_sec[[grep("gbr",country_list)]],
                 Fig_LY[[grep("gbr",country_list)]],
                 Fig_KY[[grep("gbr",country_list)]],
                 Fig_EnY[[grep("gbr",country_list)]],
                 Fig_EY[[grep("gbr",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Greece

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_sec[[grep("grc",country_list)]],
                 Fig_L_sec[[grep("grc",country_list)]],
                 Fig_LY[[grep("grc",country_list)]],
                 Fig_KY[[grep("grc",country_list)]],
                 Fig_EnY[[grep("grc",country_list)]],
                 Fig_EY[[grep("grc",country_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

# Impact in sectorial level by sector

```{r}

sector_list <- c("Agriculture","Energy intensive industry","Other industry","Construction","Transport","Services","Fossil based energy","Other energy")

Fig_Y_pays <- list()
for (i in 1:length(sector_list)) {
  
  Fig_Y_pays <- c(Fig_Y_pays,
                  list(simpleplot(data_sector,paste0("Y","_S00",i,"_",country_list),
                  country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 1, 
                  titleplot = paste0("Production of ", sector_list[i] ," sector in level (Dashed line for BAU)"))))
  
}

Fig_L_pays <- list()
for (i in 1:length(sector_list)) {
  
  Fig_L_pays <- c(Fig_L_pays,
                  list(simpleplot(data_sector,paste0("F_L","_S00",i,"_",country_list),
                  country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 1, 
                  titleplot = paste0("Employment of ", sector_list[i] ," sector in level (Dashed line for BAU)"))))
  
}

Fig_LY_pays <- list()
for (i in 1:length(sector_list)) {
  
  Fig_LY_pays <- c(Fig_LY_pays,
                  list(simpleplot(data_ratio,paste0("LY","_S00",i,"_",country_list),
                  country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 100, 
                  titleplot = paste0("Labour intensity Index over production of ", sector_list[i] ," sector (Dashed line for BAU)"))))
  
}

Fig_KY_pays <- list()
for (i in 1:length(sector_list)) {
  
  Fig_KY_pays <- c(Fig_KY_pays,
                  list(simpleplot(data_ratio,paste0("KY","_S00",i,"_",country_list),
                  country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 1, 
                  titleplot = paste0("Capital intensity Index over production of ", sector_list[i] ," sector (Dashed line for BAU)"))))
  
}

Fig_EnY_pays <- list()
for (i in 1:length(sector_list)) {
  
  Fig_EnY_pays <- c(Fig_EnY_pays,
                  list(simpleplot(data_ratio,paste0("EnY","_S00",i,"_",country_list),
                  country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 10, 
                  titleplot = paste0("Energy intensity Index over production of ", sector_list[i] ," sector (Dashed line for BAU)"))))
  
}

Fig_EY_pays <- list()
for (i in 1:length(sector_list)) {
  
  Fig_EY_pays <- c(Fig_EY_pays,
                  list(simpleplot(data_ratio,paste0("EY","_S00",i,"_",country_list),
                  country_names, startyear, endyear, scenario = "carbontax",transformation = "level", unit = 10000, 
                  titleplot = paste0("Emission intensity Index over production of ", sector_list[i] ," sector (Dashed line for BAU)"))))
  
}

```


## Agriculture

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Agriculture",sector_list)]],
                 Fig_L_pays[[grep("Agriculture",sector_list)]],
                 Fig_LY_pays[[grep("Agriculture",sector_list)]],
                 Fig_KY_pays[[grep("Agriculture",sector_list)]],
                 Fig_EnY_pays[[grep("Agriculture",sector_list)]],
                 Fig_EY_pays[[grep("Agriculture",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------


## Energy intensive industry

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Energy intensive industry",sector_list)]],
                 Fig_L_pays[[grep("Energy intensive industry",sector_list)]],
                 Fig_LY_pays[[grep("Energy intensive industry",sector_list)]],
                 Fig_KY_pays[[grep("Energy intensive industry",sector_list)]],
                 Fig_EnY_pays[[grep("Energy intensive industry",sector_list)]],
                 Fig_EY_pays[[grep("Energy intensive industry",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Other industry

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Other industry",sector_list)]],
                 Fig_L_pays[[grep("Other industry",sector_list)]],
                 Fig_LY_pays[[grep("Other industry",sector_list)]],
                 Fig_KY_pays[[grep("Other industry",sector_list)]],
                 Fig_EnY_pays[[grep("Other industry",sector_list)]],
                 Fig_EY_pays[[grep("Other industry",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Construction

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Construction",sector_list)]],
                 Fig_L_pays[[grep("Construction",sector_list)]],
                 Fig_LY_pays[[grep("Construction",sector_list)]],
                 Fig_KY_pays[[grep("Construction",sector_list)]],
                 Fig_EnY_pays[[grep("Construction",sector_list)]],
                 Fig_EY_pays[[grep("Construction",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Transport

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Transport",sector_list)]],
                 Fig_L_pays[[grep("Transport",sector_list)]],
                 Fig_LY_pays[[grep("Transport",sector_list)]],
                 Fig_KY_pays[[grep("Transport",sector_list)]],
                 Fig_EnY_pays[[grep("Transport",sector_list)]],
                 Fig_EY_pays[[grep("Transport",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Services

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Services",sector_list)]],
                 Fig_L_pays[[grep("Services",sector_list)]],
                 Fig_LY_pays[[grep("Services",sector_list)]],
                 Fig_KY_pays[[grep("Services",sector_list)]],
                 Fig_EnY_pays[[grep("Services",sector_list)]],
                 Fig_EY_pays[[grep("Services",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Fossil based energy

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Fossil based energy",sector_list)]],
                 Fig_L_pays[[grep("Fossil based energy",sector_list)]],
                 Fig_LY_pays[[grep("Fossil based energy",sector_list)]],
                 Fig_KY_pays[[grep("Fossil based energy",sector_list)]],
                 Fig_EnY_pays[[grep("Fossil based energy",sector_list)]],
                 Fig_EY_pays[[grep("Fossil based energy",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

------------------------------------------------------------------------

## Other energy

```{r, fig.height = 8, fig.width = 17}

pic <- ggarrange(Fig_Y_pays[[grep("Other energy",sector_list)]],
                 Fig_L_pays[[grep("Other energy",sector_list)]],
                 Fig_LY_pays[[grep("Other energy",sector_list)]],
                 Fig_KY_pays[[grep("Other energy",sector_list)]],
                 Fig_EnY_pays[[grep("Other energy",sector_list)]],
                 Fig_EY_pays[[grep("Other energy",sector_list)]],
                 hjust = -0.5, vjust = 1.5,
                 ncol = 3, nrow = 2,
                 widths = 2,  heights = 2,
                 common.legend = TRUE, legend = "top")

pic

```

